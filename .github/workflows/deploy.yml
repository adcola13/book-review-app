name: Deploy to EKS

on:
  workflow_dispatch:
# workflow_run:
#   workflows: ["Build and Push Images"]
#   types: [completed]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
      EKS_NAMESPACE: ${{ secrets.EKS_NAMESPACE }}
      BACKEND_REPO: ${{ secrets.ECR_BACKEND_REPO }}
      FRONTEND_REPO: ${{ secrets.ECR_FRONTEND_REPO }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - uses: azure/setup-kubectl@v4

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --region "$AWS_REGION" --name "$EKS_CLUSTER_NAME"

      - name: Ensure namespace exists
        run: kubectl apply -f k8s/namespace.yaml

      - name: Apply manifests
        run: kubectl apply -n ${EKS_NAMESPACE} -f k8s/

      # ----------------------------------------------------
      # Fetch ALB hostname
      # ----------------------------------------------------
      - name: Fetch ALB hostname
        id: fetch_alb
        run: |
          for i in {1..30}; do
            HOST=$(kubectl get ingress book-review-ingress -n ${EKS_NAMESPACE} \
              -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || true)
            [ -n "$HOST" ] && break
            sleep 10
          done

          if [ -z "$HOST" ]; then
            echo "ALB hostname not found"
            exit 1
          fi

          echo "ALLOWED_ORIGINS=http://localhost:3000,http://${HOST}" >> $GITHUB_ENV
          echo "alb_url=http://${HOST}" >> $GITHUB_OUTPUT

      # ----------------------------------------------------
      # Create backend secret ONCE (correct)
      # ----------------------------------------------------
      - name: Create backend secret
        run: |
          DB_HOST=$(aws ssm get-parameter --name "${{ secrets.DB_HOST }}" --query Parameter.Value --output text)
          DB_NAME=$(aws ssm get-parameter --name "${{ secrets.DB_NAME }}" --query Parameter.Value --output text)
          DB_USER=$(aws ssm get-parameter --name "${{ secrets.DB_USERNAME }}" --query Parameter.Value --output text)
          DB_PASS=$(aws ssm get-parameter --name "${{ secrets.DB_SSM_PATH }}" --with-decryption --query Parameter.Value --output text)

          kubectl create secret generic book-review-backend-env \
            -n ${EKS_NAMESPACE} \
            --from-literal=DB_HOST="$DB_HOST" \
            --from-literal=DB_NAME="$DB_NAME" \
            --from-literal=DB_USER="$DB_USER" \
            --from-literal=DB_PASS="$DB_PASS" \
            --from-literal=DB_DIALECT="mysql" \
            --from-literal=ALLOWED_ORIGINS="$ALLOWED_ORIGINS" \
            --from-literal=JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Update images
        run: |
          kubectl -n ${EKS_NAMESPACE} set image deployment/book-review-backend backend=${BACKEND_REPO}:latest
          kubectl -n ${EKS_NAMESPACE} set image deployment/book-review-frontend frontend=${FRONTEND_REPO}:latest

      - name: Restart backend
        run: kubectl rollout restart deployment/book-review-backend -n ${EKS_NAMESPACE}
